<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Proctor & Examiner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .neo-brutalist { border: 4px solid black; box-shadow: 8px 8px 0px 0px rgba(0,0,0,1); transition: all 0.2s ease; }
        .neo-brutalist:active { transform: translate(3px, 3px); box-shadow: 4px 4px 0px 0px rgba(0,0,0,1); }
        .recording { animation: pulse 1.5s infinite; background-color: #ef4444; border-color: white; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8 font-mono text-black">

    <div class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
        
        <div class="md:col-span-1 space-y-4">
            <div class="neo-brutalist bg-white p-2">
                <div class="bg-black text-white text-center font-bold uppercase text-xs py-1 mb-2">Live Proctoring</div>
                <video id="webcam" autoplay playsinline muted class="w-full bg-black h-48 object-cover transform scale-x-[-1] border-2 border-black"></video>
                <canvas id="snapshot-canvas" class="hidden"></canvas>
            </div>
            
            <div class="neo-brutalist bg-red-100 p-4 border-red-600 border-4">
                <h3 class="font-black uppercase text-red-600">Integrity Score</h3>
                <div class="text-4xl font-black text-red-600 mt-2">
                    <span id="strike-count">0</span> / 3 <span class="text-lg">Strikes</span>
                </div>
            </div>
        </div>

        <div class="md:col-span-2 space-y-6">
            
            <section id="view-register" class="neo-brutalist bg-white p-12 text-center">
                <h2 class="text-3xl font-black uppercase mb-2">Identity Setup</h2>
                <p class="mb-6 font-bold text-gray-600">Please align your face in the camera and register your ID.</p>
                
                <input type="text" id="student-id" placeholder="Enter Student ID (e.g. 101)" class="border-4 border-black p-4 w-full md:w-2/3 mb-4 font-bold text-xl text-center">
                <button onclick="registerFace()" class="bg-black text-white font-bold py-4 px-8 w-full md:w-2/3 uppercase hover:bg-green-500 transition-colors border-4 border-black text-xl">üì∏ Register Face</button>
                
                <p id="register-status" class="mt-4 font-bold text-lg hidden"></p>
            </section>

            <section id="view-upload" class="hidden neo-brutalist bg-white p-12 text-center">
                <h2 class="text-2xl font-black uppercase mb-6">Load Exam Paper</h2>
                <p id="upload-status" class="hidden text-xl font-bold text-blue-600 mb-4 animate-pulse">‚è≥ Scanning PDF...</p>

                <div class="border-4 border-dashed border-black p-12 bg-gray-50 cursor-pointer hover:bg-blue-100 transition" onclick="document.getElementById('pdf-file').click()">
                    <span class="text-5xl">üìÑ</span>
                    <p class="font-bold mt-4 uppercase">Click to browse (.pdf)</p>
                    <input type="file" id="pdf-file" class="hidden" accept=".pdf">
                </div>
            </section>

            <section id="view-interview" class="hidden space-y-6">
                <div class="neo-brutalist bg-white p-8 relative">
                    <span class="absolute -top-4 -left-4 bg-black text-white px-4 py-1 font-bold uppercase" id="q-number">Q1</span>
                    <h3 id="ai-question" class="text-2xl font-black mt-2">...</h3>
                </div>

                <div id="recording-area" class="flex flex-col items-center gap-4 bg-white neo-brutalist p-8">
                    <button id="record-btn" class="neo-brutalist bg-yellow-400 w-24 h-24 rounded-full text-4xl flex items-center justify-center hover:scale-105 transition-transform">üé§</button>
                    <p id="status-text" class="font-bold uppercase tracking-widest text-sm text-center">Tap to Start Answering</p>
                </div>

                <div id="review-area" class="hidden neo-brutalist bg-white p-6 border-blue-600 border-4">
                    <h4 class="text-xl font-black uppercase mb-2 text-blue-600">Live Transcript</h4>
                    <p id="edit-instructions" class="text-xs font-bold text-red-500 mb-2 uppercase animate-pulse">üî¥ Listening... Text is locked.</p>
                    
                    <textarea id="user-input" class="w-full border-2 border-black p-4 font-bold text-lg h-32 bg-gray-200 cursor-not-allowed" readonly></textarea>
                    
                    <div class="flex gap-4 mt-4">
                        <button onclick="resetRecording()" class="w-1/2 border-2 border-black py-3 font-bold uppercase hover:bg-gray-200">‚ùå Restart Audio</button>
                        <button id="submit-btn" onclick="submitFinalAnswer()" class="w-1/2 bg-black text-white py-3 font-bold uppercase hover:bg-green-500 hidden">‚úÖ Submit Final</button>
                    </div>
                </div>

                <div id="result-box" class="hidden neo-brutalist p-6 border-black bg-gray-50">
                    <div class="flex justify-between items-center mb-4 border-b-2 border-black pb-2">
                        <h4 class="text-xl font-black uppercase">Grade</h4>
                        <span id="points-badge" class="bg-black text-white px-4 py-1 font-bold">0/10</span>
                    </div>
                    <p id="ai-reason" class="font-bold text-lg mb-4">...</p>
                    <button onclick="nextQuestion()" class="w-full bg-black text-white py-4 font-bold uppercase hover:bg-yellow-400 hover:text-black">Next ‚ûî</button>
                </div>
            </section>

            <section id="view-report" class="hidden neo-brutalist bg-white p-12 text-center">
                <h2 class="text-4xl font-black uppercase mb-4">Final Score</h2>
                <div class="text-8xl font-black mb-6 text-green-600" id="final-score">0%</div>
                <p class="font-bold">Exam completed successfully.</p>
            </section>
        </div>
    </div>

    <script>
        let questions = [], currentIdx = 0, totalScore = 0, strikes = 0;
        let isRecording = false;
        const API_BASE = "http://localhost:8000";
        
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('snapshot-canvas');

        navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
            video.srcObject = stream;
        }).catch(err => alert("Camera & Mic access required!"));

        function captureBlob() {
            return new Promise(resolve => {
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                canvas.toBlob(resolve, 'image/jpeg', 0.8);
            });
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                document.getElementById('user-input').value = finalTranscript + interimTranscript; 
            };
        } else {
            alert("Please use Chrome or Edge for live transcription.");
        }

        async function registerFace() {
            const studentId = document.getElementById('student-id').value.trim();
            const statusEl = document.getElementById('register-status');
            if(!studentId) { alert("Please enter Student ID."); return; }

            statusEl.classList.remove('hidden', 'text-green-600', 'text-red-600');
            statusEl.classList.add('text-blue-600');
            statusEl.innerText = "Processing Face...";

            const imgBlob = await captureBlob();
            const fd = new FormData();
            fd.append('student_id', studentId);
            fd.append('image', imgBlob);

            try {
                const res = await fetch(`${API_BASE}/register-face`, { method: 'POST', body: fd });
                const data = await res.json();
                
                if(data.status === "SUCCESS") {
                    statusEl.innerText = data.message;
                    statusEl.classList.replace('text-blue-600', 'text-green-600');
                    setTimeout(() => {
                        document.getElementById('view-register').classList.add('hidden');
                        document.getElementById('view-upload').classList.remove('hidden');
                    }, 1000);
                } else {
                    statusEl.innerText = data.message;
                    statusEl.classList.replace('text-blue-600', 'text-red-600');
                }
            } catch(e) {
                statusEl.innerText = "Server Error. Is backend running?";
                statusEl.classList.replace('text-blue-600', 'text-red-600');
            }
        }

        document.getElementById('pdf-file').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const statusText = document.getElementById('upload-status');
            statusText.classList.remove('hidden');
            statusText.innerText = `‚è≥ Scanning ${file.name}...`;

            const fd = new FormData(); fd.append('file', file);
            try {
                const res = await fetch(`${API_BASE}/process-pdf`, { method: 'POST', body: fd });
                questions = await res.json();
                
                if(questions.length > 0) {
                    document.getElementById('view-upload').classList.add('hidden');
                    document.getElementById('view-interview').classList.remove('hidden');
                    loadQuestion(0);
                } else {
                    statusText.innerText = "‚ùå No questions found.";
                    statusText.classList.replace('text-blue-600', 'text-red-600');
                }
            } catch (err) {
                statusText.innerText = "‚ùå Connection Failed.";
            }
        };

        function loadQuestion(idx) {
            currentIdx = idx;
            document.getElementById('result-box').classList.add('hidden');
            document.getElementById('review-area').classList.add('hidden');
            document.getElementById('recording-area').classList.remove('hidden');
            document.getElementById('q-number').innerText = `Q${idx + 1}`;
            document.getElementById('ai-question').innerText = questions[idx].question;
            document.getElementById('user-input').value = "";
            window.speechSynthesis.speak(new SpeechSynthesisUtterance(questions[idx].question));
            
            document.getElementById('status-text').innerText = "Tap to Start Answering";
            document.getElementById('submit-btn').classList.add('hidden'); 
        }

        document.getElementById('record-btn').onclick = () => {
            if (!recognition) return;
            const inputArea = document.getElementById('user-input');
            const instructions = document.getElementById('edit-instructions');
            const submitBtn = document.getElementById('submit-btn');

            if (!isRecording) {
                inputArea.value = ""; 
                document.getElementById('recording-area').classList.add('hidden');
                document.getElementById('review-area').classList.remove('hidden'); 
                
                inputArea.readOnly = true; 
                inputArea.classList.add('bg-gray-200', 'cursor-not-allowed');
                inputArea.classList.remove('bg-white');
                
                instructions.innerText = "üî¥ Listening... Text is locked.";
                instructions.classList.replace('text-green-600', 'text-red-500');
                instructions.classList.add('animate-pulse');
                submitBtn.classList.add('hidden'); 
                
                recognition.start();
                isRecording = true;
                
                document.getElementById('record-btn').classList.add('recording');
                document.getElementById('status-text').innerText = "Tap to Stop & Edit";
                document.getElementById('recording-area').classList.remove('hidden'); 
            } else {
                recognition.stop();
                isRecording = false;
                
                inputArea.readOnly = false; 
                inputArea.classList.remove('bg-gray-200', 'cursor-not-allowed');
                inputArea.classList.add('bg-white');
                
                instructions.innerText = "‚úÖ Done! You can now edit your text manually.";
                instructions.classList.replace('text-red-500', 'text-green-600');
                instructions.classList.remove('animate-pulse');
                submitBtn.classList.remove('hidden'); 
                
                document.getElementById('record-btn').classList.remove('recording');
                document.getElementById('recording-area').classList.add('hidden'); 
            }
        };

        function resetRecording() {
            document.getElementById('user-input').value = "";
            document.getElementById('review-area').classList.add('hidden');
            document.getElementById('recording-area').classList.remove('hidden');
            document.getElementById('status-text').innerText = "Tap to Start Answering";
            isRecording = false;
            try { recognition.stop(); } catch(e) {}
        }

        async function submitFinalAnswer() {
            const btn = document.getElementById('submit-btn');
            btn.innerText = "‚è≥ Grading..."; btn.disabled = true;

            const text = document.getElementById('user-input').value;
            const studentId = document.getElementById('student-id').value;
            const imgBlob = await captureBlob(); 
            
            const fd = new FormData();
            fd.append('question', questions[currentIdx].question);
            fd.append('user_text', text);
            fd.append('correct_answer', questions[currentIdx].answer);
            fd.append('student_id', studentId);
            fd.append('image', imgBlob);

            try {
                const res = await fetch(`${API_BASE}/grade`, { method: 'POST', body: fd });
                const data = await res.json();

                if (data.face_status !== "OK") {
                    strikes++;
                    document.getElementById('strike-count').innerText = strikes;
                    alert(`‚ö†Ô∏è SECURITY ALERT: ${data.face_status}\nEnsure you are clearly visible.`);
                }

                totalScore += data.score;
                document.getElementById('review-area').classList.add('hidden');
                
                const box = document.getElementById('result-box');
                box.classList.remove('hidden', 'bg-green-100', 'bg-red-100');
                box.classList.add(data.score >= 5 ? 'bg-green-100' : 'bg-red-100');
                
                document.getElementById('points-badge').innerText = `${data.score}/10`;
                document.getElementById('ai-reason').innerText = data.feedback;
                
            } catch(e) {
                alert("Error connecting to server for grading.");
            } finally {
                btn.innerText = "‚úÖ Submit Final"; btn.disabled = false;
            }
        }

        window.nextQuestion = () => {
            if (currentIdx + 1 < questions.length) loadQuestion(currentIdx + 1);
            else {
                document.getElementById('view-interview').classList.add('hidden');
                document.getElementById('view-report').classList.remove('hidden');
                document.getElementById('final-score').innerText = `${Math.round((totalScore / (questions.length * 10)) * 100)}%`;
            }
        };
    </script>
</body>
</html>